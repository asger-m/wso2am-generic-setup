!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Jolokia=e()}(this,(function(){"use strict";const t={cache:"no-store",credentials:"same-origin",redirect:"error"},e=["maxDepth","maxCollectionSize","maxObjects","serializeLong","ignoreErrors","includeStackTrace","serializeException","canonicalNaming","mimeType","includeRequest","ifModifiedSince"],n=function(e){if(!new.target)return new n(e);const i=[];let l;const f={};let h=!1,d=null;function p(t){const e=i.length;return i[e]=t,e}function g(t,e){const n=b[e];if(!n)throw new Error("Unsupported notification mode '"+e+"'");return function(e,r,o){return n[t]?.apply(n,[e,r,o])}}"string"==typeof e&&(e={url:e}),Object.assign(f,t,e),this.request=async function(t,e){const n=r(t,f,e);return"POST"===n.fetchOptions.method&&(n.fetchOptions.body=JSON.stringify(t)),o(n)},this.register=function(t,...e){if(!e||0==e.length)throw"At a least one request must be provided";const n={requests:e};if("function"==typeof t)n.callback=t;else{if("callback"in t)n.callback=t.callback;else{if(!("success"in t)||!("error"in t))throw"Either 'callback' or ('success' and 'error') callback must be provided when registering a Jolokia job";n.success=t.success,n.error=t.error}n.config=t.config,n.onlyIfModified=t.onlyIfModified}return p(n)},this.unregister=function(t){t<i.length&&delete i[t]},this.jobs=function(){const t=[];for(let e=0;e<i.length;e++)i[e]&&t.push(e);return t},this.start=function(t){if(t=t||f.fetchInterval||3e4,h){if(t===f.fetchInterval)return;this.stop()}f.fetchInterval=t,d=setInterval(function(t,e){const n=r([],e,{method:"post"});return function(){const e=[],r=[],i=[];for(let n=0;n<t.length;n++){const o=t[n];if(o){const t=o.requests.length;if(o.success){const a=s(o,n),l=c(o,n);for(let n=0;n<t;n++)i.push(u(o,n)),e.push(a),r.push(l)}else if(o.callback){const s=a(o,n);for(let n=0;n<t-1;n++)i.push(u(o,n)),e.push(s.cb),r.push(s.cb);i.push(u(o,t-1)),e.push(s.lcb),r.push(s.lcb)}}}i.length>0&&(n.fetchOptions.body=JSON.stringify(i),n.successCb=function(t,n){e[n](t,n)},n.errorCb=function(t,e){r[e](t,e)},n.fetchErrorCb=function(t,e){t?console.error("Problem executing registered jobs: ",t.status,t.statusText):console.error("Problem executing registered jobs: ",e)},o(n))}}(i,f),t),h=!0},this.stop=function(){h&&(clearInterval(d),d=null,h=!1)},this.isRunning=function(){return h},this.addNotificationListener=async function(t){await async function(t){return l?Promise.resolve(!0):t.request({type:"notification",command:"register"},{method:"post"}).then((t=>{const e=t;if(n.isError(e))throw new Error("Can not register client for notifications: "+e.error+"\nTrace:\n"+e.stacktrace);return l=e.value,!0}))}(this);const e=function(t,e){const n=t.backend||{};let r=e.mode;if(!r&&(r=n.sse?"sse":n.pull?"pull":void 0,!r&&1===n.length))return Object.keys(n)[0];if(!r||!n[r])throw new Error("Notification mode must be one of ["+Object.keys(n)+"]"+(r?', and not "'+r+'"':""));return r}(l,t);return g("lazy-init",e)(),await this.request({type:"notification",command:"add",mode:e,client:l.id,mbean:t.mbean,filter:t.filter,config:t.config,handback:t.handback},{method:"post"}).then((r=>{const o=r;if(n.isError(o))throw new Error("Cannot not add notification subscription for "+t.mbean+" (client: "+l.id+"): "+o.error);const i={id:o.value,mode:e};return g("add",e)(this,i,t),i}))},this.removeNotificationListener=async function(t){return g("remove",t.mode)(this,t),await this.request({type:"notification",command:"remove",client:l.id,handle:t.id},{method:"post"}).then((t=>{const e=t;return!n.isError(e)}))},this.unregisterNotificationClient=async function(){const t=l.backend||{};for(const e in b)b[e]&&t[e]&&g("unregister",e)();return await this.request({type:"notification",command:"unregister",client:l.id},{method:"post"}).then((t=>{const e=t;return!n.isError(e)}))};const b={pull:{add:function(t,e,r){const o={callback:function(...t){if(t.length>0&&!n.isError(t[0])){const e=t[0].value;e&&e.notifications&&e.notifications.length>0&&r?.callback?.(e)}},requests:[{type:"exec",mbean:l.backend.pull.store,operation:"pull",arguments:[l.id,e.id]}]};this.jobIds[e.id]=p(o)},remove:function(t,e){const n=this.jobIds[e.id];null!=n&&(t.unregister(n),delete this.jobIds[e.id])},unregister:function(t){for(const e in this.jobIds)null!=this.jobIds[e]&&t.unregister(this.jobIds[e]);this.jobIds={}},jobIds:{}},sse:{"lazy-init":function(){if(!this.eventSource){this.eventSource=new EventSource(f.url+"/notification/open/"+l.id+"/sse");const t=this.dispatchMap;this.eventSource.addEventListener("message",(function(e){const n=JSON.parse(e.data);if(n.handle){const e=t[n.handle];e?.(n)}}))}},add:function(t,e,n){this.dispatchMap[e.id]=n.callback},remove:function(t,e){delete this.dispatchMap[e.id]},unregister:function(){this.dispatchMap={},this.eventSource?.close(),this.eventSource=null},dispatchMap:{},eventSource:null}}};function r(r,o,s){const c=Object.assign({},o,{dataType:"json"},s);l(c.url,"No URL given");const a=Object.assign({},t);a.headers={};const u=function(t,e){const n=e?.method?.toLowerCase();let r;if(!t)return"get";if(n){if("get"===n){if(Array.isArray(t))throw new Error("Cannot use GET with bulk requests");if("read"===t.type?.toLowerCase()&&"attribute"in t&&Array.isArray(t.attribute))throw new Error("Cannot use GET for read with multiple attributes");if("target"in t)throw new Error("Cannot use GET request with proxy mode");if("config"in t)throw new Error("Cannot use GET with request specific config");r="get"}else if("post"!==n)throw new Error('Illegal method "'+n+'"');r="post"}else r=Array.isArray(t)||"config"in t||"read"===t.type?.toLowerCase()&&"attribute"in t&&Array.isArray(t.attribute)||"target"in t?"post":"get";return r}(r,c);let f,h,p,g=function(t){const e="string"==typeof t?t:t.href;let n=e.length;for(;"/"===e[n-1];)n--;return e.substring(0,n)+"/"}(c.url);return c.headers&&Object.assign(a.headers,c.headers),"post"===u?(a.method="POST",Object.assign(a.headers,{"Content-Type":"text/json"})):(a.method="GET",g+=function(t){let e=t.type;l(e,"No request type given for building a GET request"),e=e.toLowerCase();const r=d[e];l(r,"Unknown request type "+e);const o=r(t),i=o.parts||[];let s=e;i.forEach((function(t){s+="/"+n.escape(t)})),o.path&&(s+=("/"===o.path[0]?"":"/")+o.path);return s}(r)),g=function(t,n){let r=t.indexOf("?")>0?"&":"?";return e.forEach((function(e){const o=n[e];null!=o&&(t+=r+e+"="+o,r="&")})),t}(g,c),c.username&&c.password&&("function"==typeof window.btoa?a.headers.Authorization="Basic "+window.btoa(c.username+":"+c.password):console.warn('Can\'t set "Authorization" header - no btoa() function available')),null!=c.timeout&&(a.signal=AbortSignal.timeout(c.timeout)),"success"in c&&(f=i(c.success),h=i(c.error)),"error"in c&&!c.success&&(f=i("ignore"),h=i(c.error)),"fetchError"in c?p="ignore"===c.fetchError?(t,e)=>{}:c.fetchError:f&&h&&(p=(t,e)=>{console.warn(e)}),{url:g,fetchOptions:a,dataType:c.dataType,resolve:c.resolve,successCb:f,errorCb:h,fetchErrorCb:p}}async function o(t){const{url:e,fetchOptions:r,dataType:o,resolve:i,successCb:s,errorCb:c,fetchErrorCb:a}=t;if(s&&c)return fetch(e,r).then((async t=>{if(200!=t.status)return void a?.(t,t.statusText);const e=t.headers.get("content-type");if("text"!==o&&e&&(e.startsWith("text/json")||e.startsWith("application/json"))){const e=await t.json(),r=Array.isArray(e)?e:[e];for(let t=0;t<r.length;t++){const e=r[t];n.isError(e)?c(e,t):s(e,t)}}else{const e=await t.text();s(e)}})).catch((t=>{a?.(null,t)}));if("response"===i)return fetch(e,r);{const t=fetch(e,r).then((async t=>{if(t.status>=400)throw t;if(200!=t.status)return t;const e=t.headers.get("content-type");return"text"!==o&&e&&(e.startsWith("text/json")||e.startsWith("application/json"))?await t.json():await t.text()}));return a?t.catch((t=>{a(null,t)})):t}}function i(t){if(!t||Array.isArray(t)&&0==t.length)return(t,e)=>{let n;n="string"==typeof t?t:JSON.stringify(t),n&&n.length>256&&(n=n.substring(0,253)+"..."),console.warn("Ignore response",'"'+n+'"',"index=",e)};if("ignore"===t)return()=>{};const e=Array.isArray(t)?t:[t];return(t,n)=>{"string"==typeof t?e[0](t):e[n%e.length](t,n)}}function s(t,e){if(!t.success)throw"Expected 'success' callback configured for the job with ID="+e;return function(n,r){t.onlyIfModified&&(t.lastModified=n.timestamp),t.success(n,e,r)}}function c(t,e){if(!t.error)throw"Expected 'error' callback configured for the job with ID="+e;return function(n,r){304!==n.status&&t.error(n,e,r)}}function a(t,e){if(!t.callback)throw"Expected 'callback' configured for the job with ID="+e;const n=[];let r=0;return{cb:o,lcb:function(e,i){o(e),n.length>0&&(t.lastModified=r,t.callback(...n))}};function o(t,e){304!==t.status&&((0===r||t.timestamp&&t.timestamp<r)&&t.timestamp&&(r=t.timestamp),n.push(t))}}function u(t,e){const n=t.requests[e],r=t.config||{},o=t.onlyIfModified&&t.lastModified?{ifModifiedSince:t.lastModified}:{};return n.config=Object.assign({},r,n.config,o),n}function l(t,e){if(null==t)throw new Error(e)}function f(t){if(null==t)return"[null]";if(Array.isArray(t)){let e="";for(let n=0;n<t.length;n++){e+=null==t[n]?"[null]":h(t[n]),n<t.length-1&&(e+=",")}return e}return h(t)}function h(t){return"string"==typeof t&&0===t.length?'""':t.toString()}Object.defineProperty(n.prototype,"CLIENT_VERSION",{value:"2.1.7",enumerable:!0,writable:!1}),n.escape=n.prototype.escape=function(t){return encodeURIComponent(t.replace(/!/g,"!!").replace(/\//g,"!/"))},n.escapePost=n.prototype.escape=function(t){return t.replace(/!/g,"!!").replace(/\//g,"!/")},n.isError=n.prototype.isError=function(t){return null==t||200!=t.status};const d={read:function(t){const e=Array.isArray(t.path)?t.path.map(n.escape).join("/"):t.path;return null==t.attribute?{parts:[t.mbean,"*"],path:e}:{parts:[t.mbean,t.attribute],path:e}},write:function(t){const e=Array.isArray(t.path)?t.path.map(n.escape).join("/"):t.path;return{parts:[t.mbean,t.attribute,f(t.value)],path:e}},exec:function(t){const e=[t.mbean,t.operation];return t.arguments&&t.arguments.length>0&&t.arguments.forEach((function(t){e.push(f(t))})),{parts:e}},version:function(t){return{}},search:function(t){return{parts:[t.mbean]}},list:function(t){return{path:t.path}},notification:function(t){switch(t.command){case"register":return{parts:["register"]};case"add":{const e=["add",f(t.client),f(t.mode),f(t.mbean)],n=[];return t.handback&&n.push(f(t.handback)),t.config?n.push(f(t.config)):n.length&&n.push("{}"),t.filter?n.push(f(t.filter)):n.length&&n.push(" "),{parts:e.concat(n.reverse())}}case"remove":return{parts:["remove",f(t.client),f(t.handle)]};case"unregister":return{parts:["unregister",f(t.client)]};case"list":return{parts:["list",f(t.client)]};case"ping":return{parts:["ping",f(t.client)]};case"open":return{parts:["open",f(t.client),f(t.mode)]};default:throw new Error("Unknown command '"+t.command+"'")}}};return n}));
